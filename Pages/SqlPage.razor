@page "/SqlPage"
@inject IJSRuntime Js;
@using MudBlazor;
@namespace allmylinks



@if (!isLoading)
{
	<div class='container-fluid'>
	<div class='row'>
		<div class='col-sm-4 pr-0'>
			<div id='infoPanel' class="card rounded-0 border-left-0">
				<table class='table table-condensed small'>
					<thead>
						<tr>
							<td colspan='2'>
								<InputFile id="upload" OnChange="UploadFiles" hidden multiple />
								<MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Filled.CloudUpload" for="upload">
									Upload Database
								</MudButton>
								@if (files != null)
									{
										<MudText Typo="@Typo.h6">@files.Count() File@(files.Count() == 1 ? "" : "s"):</MudText>
										<MudList>
											@foreach (var file in files)
											{
												<MudListItem Icon="@Icons.Filled.AttachFile" @key="@file">
													@file.Name <code>@file.Size bytes</code>
												</MudListItem>
											}
										</MudList>
									}
									<hr class='invisible-divider'>
									<p class="h6">💡 <small>Original work by Joe Shakely <cite title="sql.js/sql.js: A javascript library to run SQLite on the web."><a href="https://github.com/MessiDaGod/allmylinks" target="_blank">sql.js</a></cite> which is <a href="LICENSE.txt" target="_blank">MIT licensed</a>.</small></p>
									<p class="h6">ℹ <small>SQLite is a <abbr title="Relational Database Management System">RDBMS</abbr> with no dependencies and zero configurations; able to operate offline in-browser without a database engine.<br><mark>🚫 No server setup required to run this utility.</mark></small></p>
									<hr class='invisible-divider'>
									<span class='text-muted'>© Copyright <span id='copyrightYearDisplay'></span> by <a href='https://github.com/MessiDaGod/' target='_blank'>Joe Shakely</a> </span>
									<hr class='invisible-divider'>
									<div class="w-25 d-inline-block"><b>File Name:</b></div>
									<div id='fileNameDisplay' class="w-75 d-inline-block">---</div>
									<div class="w-25 d-inline-block"><b>File Size:</b></div>
									<div id='fileSizeDisplay' class="w-75 d-inline-block">---</div>
									<hr class='invisible-divider'>
									<div class="w-25 d-inline-block"><b>▦ Table(s):</b></div>
									<div id='noOfTablesDisplay' class="w-75 d-inline-block">---</div>
									<hr class='invisible-divider'>
								</td>
							</tr>
						</thead>
						<tbody id='dbTableDetails'></tbody>
					</table>
				</div>
			</div>
			<div class='col-sm-8 pl-0'>
				<div id='mainTabsWrapper' class='card rounded-0 border-right-0'>
					<div id='mainTabs' role='tablist'>
						<MudTabs Elevation="4" Rounded="true" Centered="false" Color="@Color.Secondary" class='nav nav-tabs'>
							<MudTabPanel Text="🔎 Browse Data">
								<p id='errorDisplay' class='m-0 p-0 small text-danger'></p>
								<div id='browse' role='tabpanel' class='tab-pane fade active show' aria-labelledby='browse-tab'>
									<div class='btn-group btn-group-sm m-0'>
										<div class='btn-group btn-group-sm'>
											<button id='exportToggleBtn' type='button' class='btn btn-sm btn-light text-info border-info dropdown-toggle rounded-0' data-toggle='dropdown'><small>💾 Save…</small></button>
											<div class='dropdown-menu'>
												<button id='exportAsJSON' type='button' class='dropdown-item'><small>💽 Export datatable as JSON</small></button>
											</div>
										</div>
										<small id='tableDetails' class='ml-2'></small>
									</div>
									<hr class='invisible-divider'>
									<div id='tableRecords' class='table-responsive'></div>
									<hr class='invisible-divider'>
									<ul id='tablePagination' class='pagination pagination-sm rounded-0'></ul>
								</div>
							</MudTabPanel>
							<MudTabPanel Text="❮⁄❯ Query Editor">
								<div id='editor' role='tabpanel' class='tab-pane fade show' aria-labelledby='editor-tab'>
									<div class='btn-group btn-group-sm m-0'>
										<div class='btn-group btn-group-sm'>
											<button id='exportQueryToggleBtn' type='button' class='btn btn-sm btn-light text-info border-info dropdown-toggle rounded-0' data-toggle='dropdown'><small>💾 Save…</small></button>
											<div class='dropdown-menu'>
												<button id='exportQueryAsJSON' type='button' class='dropdown-item'><small>💽 Export resultset as JSON</small></button>
												<button id='exportEditorQuery' type='button' class='dropdown-item'><small>📄 Export SQL query to local file</small></button>
											</div>
										</div>
										<button id='runQueryBtn' type='button' class='btn btn-sm btn-light text-primary border-primary rounded-0 ml-2'><small>Run ⯈</small></button>
										<small id='tableQueryDetails' class='ml-2'></small>
									</div>
									<hr class='invisible-divider'>
									<p class='mb-0'><textarea id='lineCounter' wrap='off' readonly>1.</textarea><textarea id='codeEditor' wrap='off'></textarea></p>
									<div id='tableQueryRecords' class='table-responsive'></div>
									<hr class='invisible-divider'>
									<ul id='tableQueryPagination' class='pagination pagination-sm rounded-0'></ul>
								</div>
							</MudTabPanel>
							<MudTabPanel Text="📝 Output Logs">
								<div id='logs' role='tabpanel' class='tab-pane fade show' aria-labelledby='logs-tab'>
									<hr class='invisible-divider'>
									<div id='logsRecords' class='table-responsive'></div>
								</div>
							</MudTabPanel>
						</MudTabs>
					</div>
				</div>
			</div>
		</div>
	</div>
}
@code {

	bool isLoading = false;
	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();
	}
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await Task.Run(() => isLoading = false);
			await Js.InvokeVoidAsync("AllMyLinks.logit", "Initializing Sql.js");
			await Init();
			await InvokeAsync(StateHasChanged);
		}
	}
	@* protected override async Task OnParametersSetAsync()
	{
		await Init();
	} *@
	protected async Task Init()
	{
		await Js.InvokeVoidAsync("Sql.init");
	}

	IList<IBrowserFile> files = new List<IBrowserFile>();
	private async Task UploadFiles(InputFileChangeEventArgs e)
	{
		for (int i = 0; i < e.GetMultipleFiles().Count; i++)
		{
			var file = e.GetMultipleFiles()[i];
			await Js.InvokeVoidAsync("AllMyLinks.logit", $"Adding file {i + 1}");
			await Task.Run(() => files.Add(file));
		}
		await Js.InvokeVoidAsync("AllMyLinks.logit", "Re-Init Sql.js");
		await Js.InvokeVoidAsync("Sql.init");
	}
}